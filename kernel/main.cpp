// Minimal UEFI framebuffer demo kernel for AstraOS 0.0.1
#include <stddef.h>
#include <stdint.h>

#include "arch/x86_64/gdt.hpp"
#include "arch/x86_64/idt.hpp"
#include "arch/x86_64/regs.hpp"

extern "C" {

#define EFIAPI __attribute__((ms_abi))

using EFI_STATUS = uint64_t;
using EFI_HANDLE = void*;
using EFI_PHYSICAL_ADDRESS = uint64_t;

struct EFI_GUID {
    uint32_t Data1;
    uint16_t Data2;
    uint16_t Data3;
    uint8_t Data4[8];
};

struct EFI_TABLE_HEADER {
    uint64_t Signature;
    uint32_t Revision;
    uint32_t HeaderSize;
    uint32_t CRC32;
    uint32_t Reserved;
};

// Forward declarations for function pointer types we call.
using EFI_LOCATE_PROTOCOL = EFI_STATUS(EFIAPI*)(EFI_GUID* Protocol, void* Registration, void** Interface);
using EFI_EXIT_BOOT_SERVICES = EFI_STATUS(EFIAPI*)(EFI_HANDLE ImageHandle, uint64_t MapKey);
using EFI_EXIT = EFI_STATUS(EFIAPI*)(EFI_HANDLE ImageHandle, EFI_STATUS ExitStatus, size_t ExitDataSize, void* ExitData);

struct EFI_BOOT_SERVICES {
    EFI_TABLE_HEADER Hdr;
    void* RaiseTPL;
    void* RestoreTPL;
    void* AllocatePages;
    void* FreePages;
    void* GetMemoryMap;
    void* AllocatePool;
    void* FreePool;
    void* CreateEvent;
    void* SetTimer;
    void* WaitForEvent;
    void* SignalEvent;
    void* CloseEvent;
    void* CheckEvent;
    void* InstallProtocolInterface;
    void* ReinstallProtocolInterface;
    void* UninstallProtocolInterface;
    void* HandleProtocol;
    void* Reserved;
    void* RegisterProtocolNotify;
    void* LocateHandle;
    void* LocateDevicePath;
    void* InstallConfigurationTable;
    void* LoadImage;
    void* StartImage;
    EFI_EXIT Exit;
    void* UnloadImage;
    EFI_EXIT_BOOT_SERVICES ExitBootServices;
    void* GetNextMonotonicCount;
    void* Stall;
    void* SetWatchdogTimer;
    void* ConnectController;
    void* DisconnectController;
    void* OpenProtocol;
    void* CloseProtocol;
    void* OpenProtocolInformation;
    void* ProtocolsPerHandle;
    void* LocateHandleBuffer;
    EFI_LOCATE_PROTOCOL LocateProtocol;
    void* InstallMultipleProtocolInterfaces;
    void* UninstallMultipleProtocolInterfaces;
    void* CalculateCrc32;
    void* CopyMem;
    void* SetMem;
    void* CreateEventEx;
};

struct EFI_SYSTEM_TABLE {
    EFI_TABLE_HEADER Hdr;
    char16_t* FirmwareVendor;
    uint32_t FirmwareRevision;
    EFI_HANDLE ConsoleInHandle;
    void* ConIn;
    EFI_HANDLE ConsoleOutHandle;
    void* ConOut;
    EFI_HANDLE StandardErrorHandle;
    void* StdErr;
    void* RuntimeServices;
    EFI_BOOT_SERVICES* BootServices;
    size_t NumberOfTableEntries;
    void* ConfigurationTable;
};

}  // extern "C"

constexpr EFI_STATUS EFI_SUCCESS = 0;

struct EFI_PIXEL_BITMASK {
    uint32_t RedMask;
    uint32_t GreenMask;
    uint32_t BlueMask;
    uint32_t ReservedMask;
};

enum EFI_GRAPHICS_PIXEL_FORMAT {
    PixelRedGreenBlueReserved8BitPerColor = 0,
    PixelBlueGreenRedReserved8BitPerColor = 1,
    PixelBitMask = 2,
    PixelBltOnly = 3,
    PixelFormatMax = 4
};

struct EFI_GRAPHICS_OUTPUT_MODE_INFORMATION {
    uint32_t Version;
    uint32_t HorizontalResolution;
    uint32_t VerticalResolution;
    EFI_GRAPHICS_PIXEL_FORMAT PixelFormat;
    EFI_PIXEL_BITMASK PixelInformation;
    uint32_t PixelsPerScanLine;
};

struct EFI_GRAPHICS_OUTPUT_PROTOCOL_MODE {
    uint32_t MaxMode;
    uint32_t Mode;
    EFI_GRAPHICS_OUTPUT_MODE_INFORMATION* Info;
    size_t SizeOfInfo;
    EFI_PHYSICAL_ADDRESS FrameBufferBase;
    size_t FrameBufferSize;
};

struct EFI_GRAPHICS_OUTPUT_PROTOCOL {
    void* QueryMode;
    void* SetMode;
    void* Blt;
    EFI_GRAPHICS_OUTPUT_PROTOCOL_MODE* Mode;
};

// Standard GOP GUID.
static EFI_GUID kGraphicsOutputProtocolGuid{
    0x9042a9de,
    0x23dc,
    0x4a38,
    {0x96, 0xfb, 0x7a, 0xde, 0xd0, 0x80, 0x51, 0x6a}};

struct Rgb {
    uint8_t r;
    uint8_t g;
    uint8_t b;
};

// Simple 8x16 bitmap font for ASCII 32..127.
static const uint8_t kFont8x16[96][16] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // ' '
    {0x18, 0x3c, 0x3c, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00},  // '!'
    {0x36, 0x36, 0x36, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '"'
    {0x36, 0x36, 0x36, 0x7f, 0x36, 0x36, 0x36, 0x7f, 0x36, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00},  // '#'
    {0x0c, 0x0c, 0x3f, 0x61, 0x60, 0x60, 0x3e, 0x03, 0x03, 0x43, 0x3f, 0x0c, 0x0c, 0x00, 0x00, 0x00},  // '$'
    {0x00, 0x00, 0x63, 0x63, 0x06, 0x0c, 0x18, 0x30, 0x60, 0xc6, 0xc6, 0x00, 0x00, 0x00, 0x00, 0x00},  // '%'
    {0x1c, 0x36, 0x36, 0x36, 0x1c, 0x18, 0x3b, 0x6e, 0x66, 0x66, 0x3b, 0x00, 0x00, 0x00, 0x00, 0x00},  // '&'
    {0x18, 0x18, 0x18, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '''
    {0x0c, 0x18, 0x30, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x30, 0x18, 0x0c, 0x00, 0x00, 0x00, 0x00},  // '('
    {0x30, 0x18, 0x0c, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x0c, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},  // ')'
    {0x00, 0x00, 0x00, 0x36, 0x1c, 0x7f, 0x1c, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '*'
    {0x00, 0x00, 0x00, 0x18, 0x18, 0x7e, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '+'
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x10, 0x00, 0x00},  // ','
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '-'
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00},  // '.'
    {0x00, 0x03, 0x03, 0x06, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '/'
    {0x3e, 0x63, 0x67, 0x6f, 0x7f, 0x7b, 0x73, 0x63, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // '0'
    {0x0c, 0x1c, 0x3c, 0x6c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00},  // '1'
    {0x3e, 0x63, 0x63, 0x03, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x63, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00},  // '2'
    {0x3e, 0x63, 0x63, 0x03, 0x06, 0x1c, 0x06, 0x03, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // '3'
    {0x06, 0x0e, 0x1e, 0x36, 0x66, 0x46, 0x7f, 0x06, 0x06, 0x06, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00},  // '4'
    {0x7f, 0x60, 0x60, 0x7e, 0x63, 0x03, 0x03, 0x03, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // '5'
    {0x1e, 0x30, 0x60, 0x60, 0x7e, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // '6'
    {0x7f, 0x63, 0x63, 0x03, 0x06, 0x0c, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},  // '7'
    {0x3e, 0x63, 0x63, 0x63, 0x63, 0x3e, 0x63, 0x63, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // '8'
    {0x3e, 0x63, 0x63, 0x63, 0x63, 0x3f, 0x03, 0x03, 0x06, 0x0c, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00},  // '9'
    {0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},  // ':'
    {0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x10, 0x00, 0x00, 0x00},  // ';'
    {0x00, 0x00, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00},  // '<'
    {0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '='
    {0x00, 0x00, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},  // '>'
    {0x3e, 0x63, 0x63, 0x03, 0x06, 0x0c, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},  // '?'
    {0x3e, 0x63, 0x63, 0x03, 0x3b, 0x7b, 0x7b, 0x7b, 0x7b, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // '@'
    {0x1c, 0x36, 0x63, 0x63, 0x63, 0x7f, 0x63, 0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'A'
    {0x7e, 0x63, 0x63, 0x63, 0x7e, 0x63, 0x63, 0x63, 0x63, 0x63, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'B'
    {0x3e, 0x63, 0x63, 0x60, 0x60, 0x60, 0x60, 0x60, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'C'
    {0x7c, 0x66, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x66, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'D'
    {0x7f, 0x60, 0x60, 0x60, 0x7e, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'E'
    {0x7f, 0x60, 0x60, 0x60, 0x7e, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'F'
    {0x3e, 0x63, 0x63, 0x60, 0x60, 0x6f, 0x63, 0x63, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'G'
    {0x63, 0x63, 0x63, 0x63, 0x7f, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'H'
    {0x3c, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'I'
    {0x1f, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x6c, 0x6c, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'J'
    {0x63, 0x63, 0x66, 0x6c, 0x78, 0x70, 0x78, 0x6c, 0x66, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'K'
    {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'L'
    {0x63, 0x77, 0x7f, 0x7f, 0x6b, 0x6b, 0x63, 0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'M'
    {0x63, 0x63, 0x73, 0x7b, 0x7f, 0x6f, 0x67, 0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'N'
    {0x3e, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'O'
    {0x7e, 0x63, 0x63, 0x63, 0x7e, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'P'
    {0x3e, 0x63, 0x63, 0x63, 0x63, 0x63, 0x6b, 0x6f, 0x63, 0x63, 0x3d, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'Q'
    {0x7e, 0x63, 0x63, 0x63, 0x7e, 0x6c, 0x66, 0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'R'
    {0x3e, 0x63, 0x63, 0x30, 0x1c, 0x06, 0x03, 0x03, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'S'
    {0x7e, 0x5a, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'T'
    {0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'U'
    {0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x36, 0x36, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'V'
    {0x63, 0x63, 0x63, 0x63, 0x63, 0x6b, 0x6b, 0x7f, 0x7f, 0x77, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'W'
    {0x63, 0x63, 0x36, 0x36, 0x1c, 0x1c, 0x1c, 0x36, 0x36, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'X'
    {0x63, 0x63, 0x63, 0x36, 0x36, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'Y'
    {0x7f, 0x63, 0x63, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x63, 0x63, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'Z'
    {0x3c, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00},  // '['
    {0x00, 0xc0, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '\'
    {0x3c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00},  // ']'
    {0x08, 0x1c, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '^'
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff},  // '_'
    {0x30, 0x30, 0x18, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '`'
    {0x00, 0x00, 0x00, 0x00, 0x3c, 0x06, 0x06, 0x3e, 0x66, 0x66, 0x3b, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'a'
    {0x60, 0x60, 0x60, 0x60, 0x6e, 0x73, 0x63, 0x63, 0x63, 0x73, 0x6e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'b'
    {0x00, 0x00, 0x00, 0x00, 0x3e, 0x63, 0x60, 0x60, 0x60, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'c'
    {0x03, 0x03, 0x03, 0x03, 0x3b, 0x67, 0x63, 0x63, 0x63, 0x67, 0x3b, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'd'
    {0x00, 0x00, 0x00, 0x00, 0x3e, 0x63, 0x63, 0x7f, 0x60, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'e'
    {0x0e, 0x1b, 0x33, 0x30, 0x30, 0x7c, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'f'
    {0x00, 0x00, 0x00, 0x00, 0x3b, 0x67, 0x63, 0x63, 0x63, 0x67, 0x3b, 0x03, 0x63, 0x63, 0x3e, 0x00},  // 'g'
    {0x60, 0x60, 0x60, 0x60, 0x6e, 0x73, 0x63, 0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'h'
    {0x18, 0x18, 0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'i'
    {0x06, 0x06, 0x00, 0x00, 0x0e, 0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00},  // 'j'
    {0x60, 0x60, 0x60, 0x60, 0x66, 0x6c, 0x78, 0x70, 0x78, 0x6c, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'k'
    {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'l'
    {0x00, 0x00, 0x00, 0x00, 0x76, 0x7f, 0x6b, 0x6b, 0x6b, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'm'
    {0x00, 0x00, 0x00, 0x00, 0x6e, 0x73, 0x63, 0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'n'
    {0x00, 0x00, 0x00, 0x00, 0x3e, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'o'
    {0x00, 0x00, 0x00, 0x00, 0x6e, 0x73, 0x63, 0x63, 0x63, 0x73, 0x6e, 0x60, 0x60, 0x60, 0x60, 0x00},  // 'p'
    {0x00, 0x00, 0x00, 0x00, 0x3b, 0x67, 0x63, 0x63, 0x63, 0x67, 0x3b, 0x03, 0x03, 0x03, 0x03, 0x00},  // 'q'
    {0x00, 0x00, 0x00, 0x00, 0x6e, 0x73, 0x63, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'r'
    {0x00, 0x00, 0x00, 0x00, 0x3e, 0x63, 0x60, 0x3e, 0x03, 0x63, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 's'
    {0x30, 0x30, 0x30, 0x30, 0x7c, 0x30, 0x30, 0x30, 0x30, 0x33, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00},  // 't'
    {0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x67, 0x3b, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'u'
    {0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x36, 0x36, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'v'
    {0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63, 0x6b, 0x6b, 0x7f, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'w'
    {0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x36, 0x1c, 0x1c, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'x'
    {0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63, 0x67, 0x3b, 0x03, 0x03, 0x66, 0x66, 0x3c, 0x00, 0x00},  // 'y'
    {0x00, 0x00, 0x00, 0x00, 0x7f, 0x63, 0x06, 0x0c, 0x18, 0x33, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00},  // 'z'
    {0x0e, 0x18, 0x18, 0x18, 0x18, 0x70, 0x18, 0x18, 0x18, 0x18, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00},  // '{'
    {0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},  // '|'
    {0x70, 0x18, 0x18, 0x18, 0x18, 0x0e, 0x18, 0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00},  // '}'
    {0x31, 0x6b, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // '~'
};

static uint32_t __attribute__((unused)) strlen_simple(const char* str) {
    uint32_t len = 0;
    while (str[len] != 0) {
        ++len;
    }
    return len;
}

static void draw_pixel(EFI_GRAPHICS_OUTPUT_PROTOCOL* gop, uint32_t x, uint32_t y, Rgb color) {
    auto* mode = gop->Mode;
    if (!mode || !mode->Info) {
        return;
    }
    const uint32_t width = mode->Info->HorizontalResolution;
    const uint32_t height = mode->Info->VerticalResolution;
    if (x >= width || y >= height) {
        return;
    }

    const uint32_t index = y * mode->Info->PixelsPerScanLine + x;
    auto* fb = reinterpret_cast<uint8_t*>(mode->FrameBufferBase);
    const uint32_t offset = index * 4;
    switch (mode->Info->PixelFormat) {
        case PixelRedGreenBlueReserved8BitPerColor:
            fb[offset + 0] = color.r;
            fb[offset + 1] = color.g;
            fb[offset + 2] = color.b;
            fb[offset + 3] = 0;
            break;
        case PixelBlueGreenRedReserved8BitPerColor:
        default:
            fb[offset + 0] = color.b;
            fb[offset + 1] = color.g;
            fb[offset + 2] = color.r;
            fb[offset + 3] = 0;
            break;
    }
}

static void clear_screen(EFI_GRAPHICS_OUTPUT_PROTOCOL* gop, Rgb color) {
    auto* mode = gop->Mode;
    if (!mode || !mode->Info) {
        return;
    }
    for (uint32_t y = 0; y < mode->Info->VerticalResolution; ++y) {
        for (uint32_t x = 0; x < mode->Info->HorizontalResolution; ++x) {
            draw_pixel(gop, x, y, color);
        }
    }
}

static void draw_char(EFI_GRAPHICS_OUTPUT_PROTOCOL* gop, char c, uint32_t x, uint32_t y, Rgb fg, Rgb bg) {
    if (c < 32 || c > 127) {
        return;
    }
    const uint8_t* glyph = kFont8x16[static_cast<uint32_t>(c) - 32];
    for (uint32_t row = 0; row < 16; ++row) {
        const uint8_t bits = glyph[row];
        for (uint32_t col = 0; col < 8; ++col) {
            const bool on = (bits >> (7 - col)) & 1;
            draw_pixel(gop, x + col, y + row, on ? fg : bg);
        }
    }
}

static void draw_text(EFI_GRAPHICS_OUTPUT_PROTOCOL* gop, const char* text, uint32_t start_x, uint32_t start_y, Rgb fg, Rgb bg) {
    uint32_t x = start_x;
    uint32_t y = start_y;
    for (uint32_t i = 0; text[i] != 0; ++i) {
        draw_char(gop, text[i], x, y, fg, bg);
        x += 8;
    }
}

static void draw_rect(EFI_GRAPHICS_OUTPUT_PROTOCOL* gop, uint32_t x, uint32_t y, uint32_t w, uint32_t h, Rgb color) {
    auto* mode = gop->Mode;
    if (!mode || !mode->Info) {
        return;
    }
    const uint32_t screen_w = mode->Info->HorizontalResolution;
    const uint32_t screen_h = mode->Info->VerticalResolution;
    const uint32_t x_end = (x + w > screen_w) ? screen_w : (x + w);
    const uint32_t y_end = (y + h > screen_h) ? screen_h : (y + h);
    for (uint32_t yy = y; yy < y_end; ++yy) {
        for (uint32_t xx = x; xx < x_end; ++xx) {
            draw_pixel(gop, xx, yy, color);
        }
    }
}

static void halt_forever() {
#ifdef HOST_TEST
    // In host tests we cannot execute HLT, so just return.
    return;
#else
    while (true) {
        __asm__ __volatile__("hlt");
    }
#endif
}

static void render_shell(EFI_GRAPHICS_OUTPUT_PROTOCOL* gop) {
    // Simple graphical shell mock: background, window, title, prompt.
    Rgb background{18, 18, 24};
    Rgb window{28, 28, 36};
    Rgb title_bar{40, 40, 55};
    Rgb foreground{120, 200, 255};
    Rgb accent{80, 140, 220};

    clear_screen(gop, background);

    const uint32_t screen_w = gop->Mode->Info->HorizontalResolution;
    const uint32_t screen_h = gop->Mode->Info->VerticalResolution;

    const uint32_t win_w = (screen_w > 640) ? 640 : screen_w - 32;
    const uint32_t win_h = (screen_h > 240) ? 240 : screen_h - 32;
    const uint32_t win_x = (screen_w - win_w) / 2;
    const uint32_t win_y = (screen_h - win_h) / 2;

    // Window body and title bar.
    draw_rect(gop, win_x, win_y, win_w, win_h, window);
    draw_rect(gop, win_x, win_y, win_w, 24, title_bar);

    // Title text.
    draw_text(gop, "AstraOS Shell", win_x + 12, win_y + 4, foreground, title_bar);

    // Prompt area.
    const uint32_t prompt_x = win_x + 12;
    const uint32_t prompt_y = win_y + 40;
    draw_text(gop, "AstraShell>", prompt_x, prompt_y, accent, window);
    draw_text(gop, "booted successfully!", prompt_x + 10 * 8 + 8, prompt_y, foreground, window);
}

extern "C" void kmain(EFI_GRAPHICS_OUTPUT_PROTOCOL* gop) {
#ifndef HOST_TEST
    __asm__ __volatile__("cli");
    init_gdt();
    init_idt();
#endif
    render_shell(gop);
    halt_forever();
}

extern "C" EFI_STATUS EFIAPI efi_main(EFI_HANDLE /*image_handle*/, EFI_SYSTEM_TABLE* system_table) {
    EFI_GRAPHICS_OUTPUT_PROTOCOL* gop = nullptr;
    EFI_STATUS status = system_table->BootServices->LocateProtocol(&kGraphicsOutputProtocolGuid, nullptr,
                                                                   reinterpret_cast<void**>(&gop));
    if (status != EFI_SUCCESS || gop == nullptr) {
        return status;
    }
    kmain(gop);
    return EFI_SUCCESS;
}
