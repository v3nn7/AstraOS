name: nightly-build

on:
  schedule:
    - cron: "0 23 * * *"   # 00:00 CET w czasie zimowym
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MAKEFLAGS: "-j2"

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y clang lld make mtools xorriso systemd-boot-efi

      - name: Build ISO
        run: make iso

      - name: Ensure nightly release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG=nightly
          RELEASE_ID=$(gh api repos/$GITHUB_REPOSITORY/releases/tags/$TAG --jq .id 2>/dev/null || true)
          if [ -z "$RELEASE_ID" ]; then
            gh release create "$TAG" --title "nightly" --notes "Automatyczny nightly" || true
            RELEASE_ID=$(gh api repos/$GITHUB_REPOSITORY/releases/tags/$TAG --jq .id)
          fi
          echo "release_id=$RELEASE_ID" >> "$GITHUB_OUTPUT"
          echo "release_tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Upload ISO to nightly release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ steps.release.outputs.release_tag }}" AstraOS.iso --clobber